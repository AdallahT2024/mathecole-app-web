<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math√âcole - Application √âducative Math√©matique</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Comic Neue', cursive;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bounce-animation {
            animation: bounce 1s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .pulse-success {
            animation: pulse-success 0.6s ease-in-out;
        }
        
        @keyframes pulse-success {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #10b981; }
            100% { transform: scale(1); }
        }
        
        .drag-over {
            border: 3px dashed #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
        }
        
        .number-card {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .number-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        .level-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .level-card:hover {
            transform: scale(1.05);
        }
        
        .badge {
            animation: badge-appear 0.5s ease-in-out;
        }
        
        @keyframes badge-appear {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Page d'accueil -->
    <div id="home-screen" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="text-white p-6">
            <div class="text-center">
                <h1 class="text-6xl font-bold mb-4 bounce-animation">
                    <i class="fas fa-calculator text-yellow-300 mr-4"></i>
                    Math√âcole
                </h1>
                <p class="text-xl opacity-90">Apprends les math√©matiques en t'amusant !</p>
            </div>
        </header>

        <!-- S√©lection des niveaux -->
        <main class="flex-1 container mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white mb-4">Choisis ton niveau</h2>
                <div id="user-stats" class="bg-white bg-opacity-20 rounded-lg p-4 max-w-md mx-auto">
                    <div class="flex justify-between items-center text-white">
                        <span><i class="fas fa-star text-yellow-300"></i> Points: <span id="total-points">0</span></span>
                        <span><i class="fas fa-medal text-yellow-300"></i> Badges: <span id="total-badges">0</span></span>
                    </div>
                </div>
            </div>
            
            <div class="grid md:grid-cols-5 gap-6 max-w-6xl mx-auto">
                <!-- CP -->
                <div class="level-card bg-pink-400 rounded-xl p-6 text-center text-white shadow-lg" onclick="selectLevel('CP')">
                    <i class="fas fa-baby text-4xl mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">CP</h3>
                    <p class="text-sm">Apprendre les chiffres et compter jusqu'√† 10</p>
                    <div class="mt-4 bg-white bg-opacity-20 rounded-full h-2">
                        <div class="progress-bar bg-yellow-300 h-2 rounded-full" style="width: 0%" data-level="CP"></div>
                    </div>
                </div>

                <!-- CE1 -->
                <div class="level-card bg-green-400 rounded-xl p-6 text-center text-white shadow-lg" onclick="selectLevel('CE1')">
                    <i class="fas fa-child text-4xl mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">CE1</h3>
                    <p class="text-sm">Addition et soustraction jusqu'√† 20</p>
                    <div class="mt-4 bg-white bg-opacity-20 rounded-full h-2">
                        <div class="progress-bar bg-yellow-300 h-2 rounded-full" style="width: 0%" data-level="CE1"></div>
                    </div>
                </div>

                <!-- CE2 -->
                <div class="level-card bg-blue-400 rounded-xl p-6 text-center text-white shadow-lg" onclick="selectLevel('CE2')">
                    <i class="fas fa-user-graduate text-4xl mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">CE2</h3>
                    <p class="text-sm">Tables de multiplication et g√©om√©trie</p>
                    <div class="mt-4 bg-white bg-opacity-20 rounded-full h-2">
                        <div class="progress-bar bg-yellow-300 h-2 rounded-full" style="width: 0%" data-level="CE2"></div>
                    </div>
                </div>

                <!-- CM1 -->
                <div class="level-card bg-purple-400 rounded-xl p-6 text-center text-white shadow-lg" onclick="selectLevel('CM1')">
                    <i class="fas fa-brain text-4xl mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">CM1</h3>
                    <p class="text-sm">Fractions et nombres d√©cimaux</p>
                    <div class="mt-4 bg-white bg-opacity-20 rounded-full h-2">
                        <div class="progress-bar bg-yellow-300 h-2 rounded-full" style="width: 0%" data-level="CM1"></div>
                    </div>
                </div>

                <!-- CM2 -->
                <div class="level-card bg-red-400 rounded-xl p-6 text-center text-white shadow-lg" onclick="selectLevel('CM2')">
                    <i class="fas fa-trophy text-4xl mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">CM2</h3>
                    <p class="text-sm">Probl√®mes complexes et g√©om√©trie avanc√©e</p>
                    <div class="mt-4 bg-white bg-opacity-20 rounded-full h-2">
                        <div class="progress-bar bg-yellow-300 h-2 rounded-full" style="width: 0%" data-level="CM2"></div>
                    </div>
                </div>
            </div>

            <!-- Badges obtenus -->
            <div id="badges-section" class="mt-12 text-center">
                <h3 class="text-2xl font-bold text-white mb-4">Tes badges</h3>
                <div id="badges-container" class="flex flex-wrap justify-center gap-4">
                    <!-- Les badges appara√Ætront ici -->
                </div>
            </div>
        </main>
    </div>

    <!-- Interface d'exercices -->
    <div id="exercise-screen" class="hidden min-h-screen">
        <!-- Header exercices -->
        <header class="bg-white shadow-lg p-4">
            <div class="flex justify-between items-center max-w-6xl mx-auto">
                <button onclick="goHome()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-home mr-2"></i>Accueil
                </button>
                
                <div class="text-center">
                    <h2 id="current-level" class="text-2xl font-bold text-gray-800">CP</h2>
                    <p id="current-exercise-type" class="text-gray-600">Exercice</p>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Points</div>
                        <div id="current-points" class="text-2xl font-bold text-blue-600">0</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Temps</div>
                        <div id="timer" class="text-2xl font-bold text-red-600">00:00</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Zone d'exercices -->
        <main class="flex-1 container mx-auto px-4 py-8">
            <!-- Menu des exercices -->
            <div id="exercise-menu" class="mb-8">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                    <button onclick="startExercise('calcul')" class="bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition-all">
                        <i class="fas fa-plus text-2xl mb-2"></i>
                        <div>Calcul Mental</div>
                    </button>
                    <button onclick="startExercise('drag-drop')" class="bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition-all">
                        <i class="fas fa-hand-paper text-2xl mb-2"></i>
                        <div>Glisser-D√©poser</div>
                    </button>
                    <button onclick="startExercise('geometrie')" class="bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600 transition-all">
                        <i class="fas fa-shapes text-2xl mb-2"></i>
                        <div>G√©om√©trie</div>
                    </button>
                    <button onclick="startExercise('probleme')" class="bg-orange-500 text-white p-4 rounded-lg hover:bg-orange-600 transition-all">
                        <i class="fas fa-lightbulb text-2xl mb-2"></i>
                        <div>Probl√®mes</div>
                    </button>
                </div>
            </div>

            <!-- Zone d'exercice active -->
            <div id="exercise-content" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-4xl mx-auto">
                    <div id="exercise-question" class="text-center mb-8">
                        <!-- Question appara√Ætra ici -->
                    </div>
                    
                    <div id="exercise-interaction" class="mb-8">
                        <!-- Zone d'interaction appara√Ætra ici -->
                    </div>
                    
                    <div class="text-center space-x-4">
                        <button id="check-answer" onclick="checkAnswer()" class="bg-blue-500 text-white px-8 py-3 rounded-lg hover:bg-blue-600 transition-all disabled:opacity-50">
                            <i class="fas fa-check mr-2"></i>V√©rifier
                        </button>
                        <button id="next-exercise" onclick="nextExercise()" class="hidden bg-green-500 text-white px-8 py-3 rounded-lg hover:bg-green-600 transition-all">
                            <i class="fas fa-arrow-right mr-2"></i>Suivant
                        </button>
                    </div>
                    
                    <div id="exercise-feedback" class="mt-6 text-center">
                        <!-- Feedback appara√Ætra ici -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de f√©licitations -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
            <i class="fas fa-star text-6xl text-yellow-400 mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Bravo !</h3>
            <p id="success-message" class="text-gray-600 mb-6">Excellente r√©ponse !</p>
            <button onclick="closeSuccessModal()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                Continuer
            </button>
        </div>
    </div>

    <script>
        // Variables globales
        let currentLevel = '';
        let currentExerciseType = '';
        let currentQuestion = {};
        let userAnswer = null;
        let points = parseInt(localStorage.getItem('mathpoints') || '0');
        let timer = 0;
        let timerInterval = null;
        let exerciseCount = 0;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadUserStats();
            loadProgress();
            loadBadges();
        });

        // Gestion des niveaux
        function selectLevel(level) {
            currentLevel = level;
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('exercise-screen').classList.remove('hidden');
            document.getElementById('current-level').textContent = level;
            showExerciseMenu();
        }

        function goHome() {
            document.getElementById('exercise-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
            stopTimer();
            loadUserStats();
            loadProgress();
        }

        function showExerciseMenu() {
            document.getElementById('exercise-menu').classList.remove('hidden');
            document.getElementById('exercise-content').classList.add('hidden');
        }

        // Gestion des exercices
        function startExercise(type) {
            currentExerciseType = type;
            document.getElementById('exercise-menu').classList.add('hidden');
            document.getElementById('exercise-content').classList.remove('hidden');
            document.getElementById('current-exercise-type').textContent = getExerciseTypeName(type);
            
            generateExercise();
            startTimer();
        }

        function getExerciseTypeName(type) {
            const names = {
                'calcul': 'Calcul Mental',
                'drag-drop': 'Glisser-D√©poser',
                'geometrie': 'G√©om√©trie',
                'probleme': 'Probl√®mes'
            };
            return names[type] || 'Exercice';
        }

        function generateExercise() {
            const generators = {
                'calcul': generateCalculExercise,
                'drag-drop': generateDragDropExercise,
                'geometrie': generateGeometryExercise,
                'probleme': generateProblemExercise
            };

            if (generators[currentExerciseType]) {
                generators[currentExerciseType]();
            }
        }

        // G√©n√©rateurs d'exercices par type
        function generateCalculExercise() {
            const questionEl = document.getElementById('exercise-question');
            const interactionEl = document.getElementById('exercise-interaction');
            
            let num1, num2, operation, correctAnswer;
            
            switch(currentLevel) {
                case 'CP':
                    num1 = Math.floor(Math.random() * 6) + 1;
                    num2 = Math.floor(Math.random() * 6) + 1;
                    operation = '+';
                    correctAnswer = num1 + num2;
                    break;
                case 'CE1':
                    num1 = Math.floor(Math.random() * 11) + 5;
                    num2 = Math.floor(Math.random() * 11) + 5;
                    operation = Math.random() > 0.5 ? '+' : '-';
                    if (operation === '-' && num1 < num2) [num1, num2] = [num2, num1];
                    correctAnswer = operation === '+' ? num1 + num2 : num1 - num2;
                    break;
                case 'CE2':
                    num1 = Math.floor(Math.random() * 9) + 2;
                    num2 = Math.floor(Math.random() * 9) + 2;
                    operation = '√ó';
                    correctAnswer = num1 * num2;
                    break;
                case 'CM1':
                    num1 = Math.floor(Math.random() * 100) + 10;
                    num2 = Math.floor(Math.random() * 20) + 2;
                    operation = '√∑';
                    correctAnswer = Math.floor(num1 / num2);
                    num1 = correctAnswer * num2; // Pour avoir une division exacte
                    break;
                case 'CM2':
                    num1 = Math.floor(Math.random() * 500) + 100;
                    num2 = Math.floor(Math.random() * 50) + 10;
                    const ops = ['+', '-', '√ó'];
                    operation = ops[Math.floor(Math.random() * ops.length)];
                    if (operation === '+') correctAnswer = num1 + num2;
                    else if (operation === '-') correctAnswer = num1 - num2;
                    else correctAnswer = num1 * num2;
                    break;
            }

            currentQuestion = { num1, num2, operation, correctAnswer };
            
            questionEl.innerHTML = `
                <h3 class="text-4xl font-bold mb-6">${num1} ${operation} ${num2} = ?</h3>
            `;
            
            // G√©n√©rer des choix multiples
            const choices = [correctAnswer];
            while (choices.length < 4) {
                let wrong = correctAnswer + (Math.floor(Math.random() * 21) - 10);
                if (wrong !== correctAnswer && wrong > 0 && !choices.includes(wrong)) {
                    choices.push(wrong);
                }
            }
            
            // M√©langer les choix
            choices.sort(() => Math.random() - 0.5);
            
            interactionEl.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    ${choices.map(choice => `
                        <button class="number-card bg-blue-100 hover:bg-blue-200 border-2 border-blue-300 rounded-lg p-4 text-2xl font-bold text-blue-800" onclick="selectAnswer(${choice})">
                            ${choice}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        function generateDragDropExercise() {
            const questionEl = document.getElementById('exercise-question');
            const interactionEl = document.getElementById('exercise-interaction');
            
            let targetNumber = Math.floor(Math.random() * 10) + 5;
            if (currentLevel === 'CE1' || currentLevel === 'CE2') targetNumber += 10;
            if (currentLevel === 'CM1' || currentLevel === 'CM2') targetNumber += 20;

            // G√©n√©rer des paires de nombres qui s'additionnent pour faire le nombre cible
            const pairs = [];
            const possiblePairs = [];
            
            for (let i = 1; i < targetNumber; i++) {
                possiblePairs.push([i, targetNumber - i]);
            }
            
            // Ajouter quelques mauvaises paires
            while (possiblePairs.length < 8) {
                const a = Math.floor(Math.random() * targetNumber) + 1;
                const b = Math.floor(Math.random() * targetNumber) + 1;
                if (a + b !== targetNumber && !possiblePairs.some(p => p[0] === a && p[1] === b)) {
                    possiblePairs.push([a, b]);
                }
            }
            
            // M√©langer et prendre 6 paires
            possiblePairs.sort(() => Math.random() - 0.5);
            const selectedPairs = possiblePairs.slice(0, 6);
            
            currentQuestion = { targetNumber, correctPairs: selectedPairs.filter(p => p[0] + p[1] === targetNumber) };
            
            questionEl.innerHTML = `
                <h3 class="text-3xl font-bold mb-2">Trouve les paires qui font ${targetNumber}</h3>
                <p class="text-gray-600">Glisse les nombres qui s'additionnent pour faire ${targetNumber}</p>
            `;
            
            interactionEl.innerHTML = `
                <div class="mb-6">
                    <div class="text-center mb-4">
                        <div id="drop-zone" class="inline-block bg-yellow-200 border-4 border-dashed border-yellow-400 rounded-lg p-6 min-w-64 min-h-32" ondrop="drop(event)" ondragover="allowDrop(event)">
                            <p class="text-gray-600">D√©pose tes paires ici</p>
                            <div id="dropped-pairs" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-2 max-w-2xl mx-auto">
                        ${selectedPairs.map((pair, index) => `
                            <div class="number-card bg-blue-100 border-2 border-blue-300 rounded-lg p-3 text-center" draggable="true" ondragstart="drag(event)" data-pair="${pair[0]},${pair[1]}">
                                <div class="font-bold">${pair[0]} + ${pair[1]}</div>
                                <div class="text-sm text-gray-600">= ${pair[0] + pair[1]}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateGeometryExercise() {
            const questionEl = document.getElementById('exercise-question');
            const interactionEl = document.getElementById('exercise-interaction');
            
            const shapes = ['cercle', 'carr√©', 'triangle', 'rectangle'];
            const colors = ['rouge', 'bleu', 'vert', 'jaune'];
            
            const targetShape = shapes[Math.floor(Math.random() * shapes.length)];
            const targetColor = colors[Math.floor(Math.random() * colors.length)];
            
            currentQuestion = { targetShape, targetColor };
            
            questionEl.innerHTML = `
                <h3 class="text-3xl font-bold mb-4">Trouve tous les ${targetShape}s ${targetColor}s</h3>
                <p class="text-gray-600">Clique sur toutes les formes qui correspondent</p>
            `;
            
            // G√©n√©rer une grille de formes
            const gridShapes = [];
            for (let i = 0; i < 16; i++) {
                gridShapes.push({
                    shape: shapes[Math.floor(Math.random() * shapes.length)],
                    color: colors[Math.floor(Math.random() * colors.length)],
                    selected: false
                });
            }
            
            // S'assurer qu'il y a au moins 2 formes correctes
            gridShapes[0] = { shape: targetShape, color: targetColor, selected: false };
            gridShapes[5] = { shape: targetShape, color: targetColor, selected: false };
            
            interactionEl.innerHTML = `
                <div class="grid grid-cols-4 gap-4 max-w-md mx-auto">
                    ${gridShapes.map((item, index) => `
                        <div class="shape-item w-16 h-16 border-2 border-gray-300 rounded-lg cursor-pointer flex items-center justify-center hover:border-blue-500 transition-all" onclick="toggleShape(${index})" data-shape="${item.shape}" data-color="${item.color}">
                            ${getShapeHTML(item.shape, item.color)}
                        </div>
                    `).join('')}
                </div>
            `;
            
            window.gridShapes = gridShapes; // Stocker pour la v√©rification
        }

        function generateProblemExercise() {
            const questionEl = document.getElementById('exercise-question');
            const interactionEl = document.getElementById('exercise-interaction');
            
            const problems = {
                'CP': [
                    { text: "Marie a 3 pommes. Sa maman lui donne 2 pommes de plus. Combien Marie a-t-elle de pommes maintenant ?", answer: 5 },
                    { text: "Il y a 4 oiseaux sur un arbre. 2 oiseaux s'envolent. Combien d'oiseaux reste-t-il ?", answer: 2 },
                    { text: "Paul a 6 billes. Il en perd 1. Combien de billes lui reste-t-il ?", answer: 5 }
                ],
                'CE1': [
                    { text: "Dans une classe, il y a 12 filles et 8 gar√ßons. Combien y a-t-il d'√©l√®ves en tout ?", answer: 20 },
                    { text: "L√©a a 15 autocollants. Elle en donne 7 √† son fr√®re. Combien d'autocollants lui reste-t-il ?", answer: 8 },
                    { text: "Un parking a 25 places. 18 voitures sont gar√©es. Combien de places sont libres ?", answer: 7 }
                ],
                'CE2': [
                    { text: "Un paquet contient 8 bonbons. Combien de bonbons y a-t-il dans 4 paquets ?", answer: 32 },
                    { text: "24 enfants vont au cin√©ma. Ils se mettent par groupes de 6. Combien y a-t-il de groupes ?", answer: 4 },
                    { text: "Une bo√Æte de 12 ≈ìufs co√ªte 3‚Ç¨. Combien co√ªtent 4 bo√Ætes ?", answer: 12 }
                ],
                'CM1': [
                    { text: "Pierre ach√®te 2,5 kg de pommes √† 3‚Ç¨ le kg. Combien paie-t-il ?", answer: 7.5 },
                    { text: "Un rectangle a une longueur de 8 cm et une largeur de 5 cm. Quel est son p√©rim√®tre ?", answer: 26 },
                    { text: "Une pizza est partag√©e en 8 parts √©gales. Julie en mange 3 parts. Quelle fraction de la pizza a-t-elle mang√©e ?", answer: "3/8" }
                ],
                'CM2': [
                    { text: "Un train roule √† 120 km/h. Quelle distance parcourt-il en 2h30 ?", answer: 300 },
                    { text: "Dans un magasin, un article co√ªte 45‚Ç¨. Il y a une r√©duction de 20%. Quel est le nouveau prix ?", answer: 36 },
                    { text: "Un r√©servoir de 150L se vide de 2/5 de son contenu. Combien de litres reste-t-il ?", answer: 90 }
                ]
            };
            
            const levelProblems = problems[currentLevel] || problems['CP'];
            const problem = levelProblems[Math.floor(Math.random() * levelProblems.length)];
            
            currentQuestion = problem;
            
            questionEl.innerHTML = `
                <div class="bg-blue-50 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">üìö R√©sous ce probl√®me :</h3>
                    <p class="text-lg leading-relaxed">${problem.text}</p>
                </div>
            `;
            
            interactionEl.innerHTML = `
                <div class="max-w-md mx-auto">
                    <input type="text" id="problem-answer" class="w-full p-4 border-2 border-gray-300 rounded-lg text-center text-2xl font-bold focus:border-blue-500 focus:outline-none" placeholder="Ta r√©ponse...">
                </div>
            `;
        }

        // Fonctions utilitaires
        function getShapeHTML(shape, color) {
            const colorMap = {
                'rouge': '#ef4444',
                'bleu': '#3b82f6',
                'vert': '#10b981',
                'jaune': '#f59e0b'
            };
            
            const fillColor = colorMap[color] || '#6b7280';
            
            switch(shape) {
                case 'cercle':
                    return `<div class="w-12 h-12 rounded-full" style="background-color: ${fillColor}"></div>`;
                case 'carr√©':
                    return `<div class="w-12 h-12" style="background-color: ${fillColor}"></div>`;
                case 'triangle':
                    return `<div class="w-0 h-0 border-l-6 border-r-6 border-b-12 border-l-transparent border-r-transparent" style="border-bottom-color: ${fillColor}"></div>`;
                case 'rectangle':
                    return `<div class="w-14 h-8" style="background-color: ${fillColor}"></div>`;
                default:
                    return `<div class="w-12 h-12 bg-gray-400"></div>`;
            }
        }

        // Gestion des r√©ponses
        function selectAnswer(answer) {
            userAnswer = answer;
            // Marquer la r√©ponse s√©lectionn√©e
            document.querySelectorAll('.number-card').forEach(card => {
                card.classList.remove('bg-blue-300', 'border-blue-500');
                card.classList.add('bg-blue-100', 'border-blue-300');
            });
            event.target.classList.remove('bg-blue-100', 'border-blue-300');
            event.target.classList.add('bg-blue-300', 'border-blue-500');
        }

        function checkAnswer() {
            let isCorrect = false;
            let feedbackHTML = '';
            
            switch(currentExerciseType) {
                case 'calcul':
                    isCorrect = userAnswer === currentQuestion.correctAnswer;
                    feedbackHTML = isCorrect 
                        ? `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                             <i class="fas fa-check-circle mr-2"></i>Bravo ! ${currentQuestion.num1} ${currentQuestion.operation} ${currentQuestion.num2} = ${currentQuestion.correctAnswer}
                           </div>`
                        : `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                             <i class="fas fa-times-circle mr-2"></i>Oops ! La bonne r√©ponse est ${currentQuestion.correctAnswer}
                           </div>`;
                    break;
                    
                case 'drag-drop':
                    const droppedPairs = document.querySelectorAll('#dropped-pairs .pair-item');
                    const userPairs = Array.from(droppedPairs).map(item => item.textContent.trim());
                    const correctPairs = currentQuestion.correctPairs.map(p => `${p[0]} + ${p[1]} = ${p[0] + p[1]}`);
                    isCorrect = correctPairs.every(pair => userPairs.includes(pair)) && userPairs.length === correctPairs.length;
                    feedbackHTML = isCorrect
                        ? `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                             <i class="fas fa-check-circle mr-2"></i>Parfait ! Tu as trouv√© toutes les bonnes paires !
                           </div>`
                        : `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                             <i class="fas fa-times-circle mr-2"></i>Essaie encore ! Les bonnes paires sont : ${correctPairs.join(', ')}
                           </div>`;
                    break;
                    
                case 'geometrie':
                    const selectedShapes = window.gridShapes.filter((shape, index) => {
                        const element = document.querySelector(`.shape-item[data-shape="${shape.shape}"][data-color="${shape.color}"]`);
                        return element && element.classList.contains('border-green-500');
                    });
                    const correctShapes = window.gridShapes.filter(shape => 
                        shape.shape === currentQuestion.targetShape && shape.color === currentQuestion.targetColor
                    );
                    isCorrect = selectedShapes.length === correctShapes.length;
                    feedbackHTML = isCorrect
                        ? `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                             <i class="fas fa-check-circle mr-2"></i>Excellent ! Tu as trouv√© toutes les bonnes formes !
                           </div>`
                        : `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                             <i class="fas fa-times-circle mr-2"></i>Regarde bien ! Cherche tous les ${currentQuestion.targetShape}s ${currentQuestion.targetColor}s
                           </div>`;
                    break;
                    
                case 'probleme':
                    const problemAnswer = document.getElementById('problem-answer').value.trim();
                    isCorrect = problemAnswer == currentQuestion.answer || problemAnswer === currentQuestion.answer.toString();
                    feedbackHTML = isCorrect
                        ? `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                             <i class="fas fa-check-circle mr-2"></i>Bravo ! Tu as r√©solu le probl√®me correctement !
                           </div>`
                        : `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                             <i class="fas fa-times-circle mr-2"></i>La bonne r√©ponse est : ${currentQuestion.answer}
                           </div>`;
                    break;
            }
            
            document.getElementById('exercise-feedback').innerHTML = feedbackHTML;
            
            if (isCorrect) {
                addPoints(10);
                showSuccessModal();
                checkBadges();
                document.querySelector('#exercise-content .bg-white').classList.add('pulse-success');
            } else {
                document.querySelector('#exercise-content .bg-white').classList.add('shake-animation');
                setTimeout(() => {
                    document.querySelector('#exercise-content .bg-white').classList.remove('shake-animation');
                }, 500);
            }
            
            document.getElementById('check-answer').classList.add('hidden');
            document.getElementById('next-exercise').classList.remove('hidden');
            
            exerciseCount++;
            updateProgress();
        }

        function nextExercise() {
            document.getElementById('check-answer').classList.remove('hidden');
            document.getElementById('next-exercise').classList.add('hidden');
            document.getElementById('exercise-feedback').innerHTML = '';
            document.querySelector('#exercise-content .bg-white').classList.remove('pulse-success');
            userAnswer = null;
            generateExercise();
        }

        // Gestion du drag and drop
        function allowDrop(ev) {
            ev.preventDefault();
            ev.target.closest('#drop-zone').classList.add('drag-over');
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.pair);
        }

        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const [num1, num2] = data.split(',').map(n => parseInt(n));
            const sum = num1 + num2;
            
            const droppedPairs = document.getElementById('dropped-pairs');
            const pairElement = document.createElement('div');
            pairElement.className = 'pair-item bg-white border border-gray-300 rounded p-2 text-sm';
            pairElement.textContent = `${num1} + ${num2} = ${sum}`;
            droppedPairs.appendChild(pairElement);
            
            // Supprimer l'√©l√©ment original
            const originalElements = document.querySelectorAll(`[data-pair="${data}"]`);
            originalElements.forEach(el => el.remove());
            
            ev.target.closest('#drop-zone').classList.remove('drag-over');
        }

        // Gestion des formes g√©om√©triques
        function toggleShape(index) {
            const shapeElement = document.querySelectorAll('.shape-item')[index];
            const shape = window.gridShapes[index];
            
            if (shapeElement.classList.contains('border-green-500')) {
                shapeElement.classList.remove('border-green-500', 'bg-green-100');
                shapeElement.classList.add('border-gray-300');
                shape.selected = false;
            } else {
                shapeElement.classList.remove('border-gray-300');
                shapeElement.classList.add('border-green-500', 'bg-green-100');
                shape.selected = true;
            }
        }

        // Syst√®me de points et badges
        function addPoints(pointsToAdd) {
            points += pointsToAdd;
            localStorage.setItem('mathpoints', points.toString());
            document.getElementById('current-points').textContent = points;
            document.getElementById('total-points').textContent = points;
        }

        function loadUserStats() {
            points = parseInt(localStorage.getItem('mathpoints') || '0');
            document.getElementById('total-points').textContent = points;
            document.getElementById('current-points').textContent = points;
            
            const badges = JSON.parse(localStorage.getItem('mathbadges') || '[]');
            document.getElementById('total-badges').textContent = badges.length;
        }

        function checkBadges() {
            const badges = JSON.parse(localStorage.getItem('mathbadges') || '[]');
            const newBadges = [];
            
            // Badge premiers pas
            if (!badges.includes('first-steps') && exerciseCount >= 1) {
                newBadges.push('first-steps');
            }
            
            // Badge 100 points
            if (!badges.includes('100-points') && points >= 100) {
                newBadges.push('100-points');
            }
            
            // Badge math√©maticien
            if (!badges.includes('mathematician') && points >= 500) {
                newBadges.push('mathematician');
            }
            
            // Badge g√©nie
            if (!badges.includes('genius') && points >= 1000) {
                newBadges.push('genius');
            }
            
            if (newBadges.length > 0) {
                const allBadges = [...badges, ...newBadges];
                localStorage.setItem('mathbadges', JSON.stringify(allBadges));
                showNewBadges(newBadges);
                loadBadges();
            }
        }

        function showNewBadges(newBadges) {
            newBadges.forEach(badgeId => {
                setTimeout(() => {
                    alert(`üèÜ Nouveau badge obtenu : ${getBadgeName(badgeId)} !`);
                }, 500);
            });
        }

        function getBadgeName(badgeId) {
            const names = {
                'first-steps': 'Premiers Pas',
                '100-points': 'Centenaire',
                'mathematician': 'Math√©maticien',
                'genius': 'G√©nie des Maths'
            };
            return names[badgeId] || 'Badge';
        }

        function getBadgeIcon(badgeId) {
            const icons = {
                'first-steps': 'üë∂',
                '100-points': 'üíØ',
                'mathematician': 'üßÆ',
                'genius': 'üß†'
            };
            return icons[badgeId] || 'üèÜ';
        }

        function loadBadges() {
            const badges = JSON.parse(localStorage.getItem('mathbadges') || '[]');
            const container = document.getElementById('badges-container');
            
            if (badges.length === 0) {
                container.innerHTML = '<p class="text-white opacity-75">Aucun badge obtenu pour le moment. Continue √† t\'entra√Æner !</p>';
                return;
            }
            
            container.innerHTML = badges.map(badge => `
                <div class="badge bg-yellow-400 text-yellow-900 rounded-full px-4 py-2 font-bold">
                    <span class="text-2xl mr-2">${getBadgeIcon(badge)}</span>
                    ${getBadgeName(badge)}
                </div>
            `).join('');
        }

        // Gestion du timer
        function startTimer() {
            timer = 0;
            timerInterval = setInterval(() => {
                timer++;
                const minutes = Math.floor(timer / 60);
                const seconds = timer % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Sauvegarde des progr√®s
        function updateProgress() {
            const progress = JSON.parse(localStorage.getItem('mathprogress') || '{}');
            if (!progress[currentLevel]) {
                progress[currentLevel] = 0;
            }
            progress[currentLevel] += 5; // 5% par exercice r√©ussi
            if (progress[currentLevel] > 100) progress[currentLevel] = 100;
            
            localStorage.setItem('mathprogress', JSON.stringify(progress));
            loadProgress();
        }

        function loadProgress() {
            const progress = JSON.parse(localStorage.getItem('mathprogress') || '{}');
            document.querySelectorAll('.progress-bar').forEach(bar => {
                const level = bar.dataset.level;
                const progressValue = progress[level] || 0;
                bar.style.width = `${progressValue}%`;
            });
        }

        // Modal de succ√®s
        function showSuccessModal() {
            const modal = document.getElementById('success-modal');
            const message = document.getElementById('success-message');
            
            const messages = [
                "Excellente r√©ponse ! Continue comme √ßa !",
                "Bravo ! Tu es tr√®s fort en maths !",
                "Parfait ! Tu progresses √† merveille !",
                "Super ! Tu ma√Ætrises bien cette notion !",
                "G√©nial ! Tes efforts paient !"
            ];
            
            message.textContent = messages[Math.floor(Math.random() * messages.length)];
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
            document.getElementById('success-modal').classList.remove('flex');
        }
    </script>
</body>
</html>
